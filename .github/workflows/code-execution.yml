name: 代码执行

on:
  workflow_dispatch:
    inputs:
      language:
        description: '编程语言'
        required: true
        type: choice
        options:
          - cpp
          - java
          - python
      code_base64:
        description: '源代码 (请使用BASE64编码)'
        required: true
      input_base64:
        description: '输入数据 (请使用BASE64编码)'
        required: false
        default: ''

jobs:
  execute:
    runs-on: ubuntu-latest
    
    steps:
      - name: 配置环境
        uses: actions/checkout@v3
      
      - name: 设置C++
        if: ${{ github.event.inputs.language == 'cpp' }}
        run: sudo apt-get update && sudo apt-get install -y g++
      
      - name: 设置Java
        if: ${{ github.event.inputs.language == 'java' }}
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: 设置Python
        if: ${{ github.event.inputs.language == 'python' }}
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: 准备代码文件 (从BASE64解码)
        run: |
          # 解码源代码
          if [ "${{ github.event.inputs.language }}" == "cpp" ]; then
            echo "${{ github.event.inputs.code_base64 }}" | base64 --decode > solution.cpp
          elif [ "${{ github.event.inputs.language }}" == "java" ]; then
            echo "${{ github.event.inputs.code_base64 }}" | base64 --decode > Main.java
          elif [ "${{ github.event.inputs.language }}" == "python" ]; then
            echo "${{ github.event.inputs.code_base64 }}" | base64 --decode > solution.py
          fi
          
          # 解码输入数据
          if [ -n "${{ github.event.inputs.input_base64 }}" ]; then
            echo "${{ github.event.inputs.input_base64 }}" | base64 --decode > input.txt
          else
            touch input.txt
          fi
          
          # 调试信息: 检查解码后的文件
          echo "========= 解码后的源代码 ========="
          cat solution.cpp || cat Main.java || cat solution.py
          echo "==============================="
      
      - name: 编译与执行C++
        if: ${{ github.event.inputs.language == 'cpp' }}
        run: |
          # 编译
          g++ -std=c++17 solution.cpp -o solution 2> compile_error.txt
          if [ $? -ne 0 ]; then
            echo "::error file=solution.cpp::编译错误"
            cat compile_error.txt
            echo "状态: CE (编译错误)" > result.txt
            echo "错误详情:" >> result.txt
            cat compile_error.txt >> result.txt
            exit 0
          fi
          
          # 执行
          timeout 2s ./solution < input.txt > output.txt 2> error.txt
          EXIT_CODE=$?
          if [ $EXIT_CODE -eq 124 ]; then
            echo "::warning file=solution.cpp::程序超时"
            echo "状态: TLE (超时)" > result.txt
            exit 0
          elif [ $EXIT_CODE -ne 0 ]; then
            echo "::error file=solution.cpp::运行时错误"
            cat error.txt
            echo "状态: RE (运行时错误)" > result.txt
            echo "错误详情:" >> result.txt
            cat error.txt >> result.txt
            exit 0
          fi
          
          echo "::notice file=solution.cpp::执行成功"
          echo "状态: AC (通过)" > result.txt
          echo "输出:" >> result.txt
          cat output.txt >> result.txt
      
      - name: 编译与执行Java
        if: ${{ github.event.inputs.language == 'java' }}
        run: |
          # 编译
          javac Main.java 2> compile_error.txt
          if [ $? -ne 0 ]; then
            echo "::error file=Main.java::编译错误"
            cat compile_error.txt
            echo "状态: CE (编译错误)" > result.txt
            echo "错误详情:" >> result.txt
            cat compile_error.txt >> result.txt
            exit 0
          fi
          
          # 执行
          timeout 2s java Main < input.txt > output.txt 2> error.txt
          EXIT_CODE=$?
          if [ $EXIT_CODE -eq 124 ]; then
            echo "::warning file=Main.java::程序超时"
            echo "状态: TLE (超时)" > result.txt
            exit 0
          elif [ $EXIT_CODE -ne 0 ]; then
            echo "::error file=Main.java::运行时错误"
            cat error.txt
            echo "状态: RE (运行时错误)" > result.txt
            echo "错误详情:" >> result.txt
            cat error.txt >> result.txt
            exit 0
          fi
          
          echo "::notice file=Main.java::执行成功"
          echo "状态: AC (通过)" > result.txt
          echo "输出:" >> result.txt
          cat output.txt >> result.txt
      
      - name: 执行Python
        if: ${{ github.event.inputs.language == 'python' }}
        run: |
          # 执行
          timeout 2s python3 solution.py < input.txt > output.txt 2> error.txt
          EXIT_CODE=$?
          if [ $EXIT_CODE -eq 124 ]; then
            echo "::warning file=solution.py::程序超时"
            echo "状态: TLE (超时)" > result.txt
            exit 0
          elif [ $EXIT_CODE -ne 0 ]; then
            echo "::error file=solution.py::运行时错误"
            cat error.txt
            echo "状态: RE (运行时错误)" > result.txt
            echo "错误详情:" >> result.txt
            cat error.txt >> result.txt
            exit 0
          fi
          
          echo "::notice file=solution.py::执行成功"
          echo "状态: AC (通过)" > result.txt
          echo "输出:" >> result.txt
          cat output.txt >> result.txt
      
      - name: 上传结果
        uses: actions/upload-artifact@v4
        with:
          name: execution-results
          path: result.txt