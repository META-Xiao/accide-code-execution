name: 代码执行

on:
  workflow_dispatch:
    inputs:
      language:
        description: '编程语言'
        required: true
        type: choice
        options:
          - cpp
          - java
          - python
      code:
        description: '源代码'
        required: true
      input:
        description: '输入数据'
        required: false
        default: ''

jobs:
  execute:
    runs-on: ubuntu-latest
    
    steps:
      - name: 配置环境
        uses: actions/checkout@v3
      
      - name: 设置C++
        if: ${{ github.event.inputs.language == 'cpp' }}
        run: sudo apt-get update && sudo apt-get install -y g++
      
      - name: 设置Java
        if: ${{ github.event.inputs.language == 'java' }}
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: 设置Python
        if: ${{ github.event.inputs.language == 'python' }}
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: 准备代码文件
        run: |
          # 创建源代码文件
          if [ "${{ github.event.inputs.language }}" == "cpp" ]; then
            echo '${{ github.event.inputs.code }}' > solution.cpp
          elif [ "${{ github.event.inputs.language }}" == "java" ]; then
            echo '${{ github.event.inputs.code }}' > Main.java
          elif [ "${{ github.event.inputs.language }}" == "python" ]; then
            echo '${{ github.event.inputs.code }}' > solution.py
          fi
          
          # 创建输入文件
          echo '${{ github.event.inputs.input }}' > input.txt
      
      - name: 编译与执行C++
        if: ${{ github.event.inputs.language == 'cpp' }}
        run: |
          # 编译
          g++ -std=c++17 solution.cpp -o solution 2> compile_error.txt
          if [ $? -ne 0 ]; then
            echo "::error::编译错误"
            cat compile_error.txt
            echo "状态: CE (编译错误)" >> result.txt
            exit 0
          fi
          
          # 执行
          timeout 2s ./solution < input.txt > output.txt 2> error.txt
          if [ $? -eq 124 ]; then
            echo "::warning::程序超时"
            echo "状态: TLE (超时)" >> result.txt
            exit 0
          elif [ $? -ne 0 ]; then
            echo "::error::运行时错误"
            cat error.txt
            echo "状态: RE (运行时错误)" >> result.txt
            exit 0
          fi
          
          echo "::notice::执行成功"
          echo "状态: AC (通过)" >> result.txt
          echo "输出:" >> result.txt
          cat output.txt >> result.txt
      
      - name: 编译与执行Java
        if: ${{ github.event.inputs.language == 'java' }}
        run: |
          # 编译
          javac Main.java 2> compile_error.txt
          if [ $? -ne 0 ]; then
            echo "::error::编译错误"
            cat compile_error.txt
            echo "状态: CE (编译错误)" >> result.txt
            exit 0
          fi
          
          # 执行
          timeout 2s java Main < input.txt > output.txt 2> error.txt
          if [ $? -eq 124 ]; then
            echo "::warning::程序超时"
            echo "状态: TLE (超时)" >> result.txt
            exit 0
          elif [ $? -ne 0 ]; then
            echo "::error::运行时错误"
            cat error.txt
            echo "状态: RE (运行时错误)" >> result.txt
            exit 0
          fi
          
          echo "::notice::执行成功"
          echo "状态: AC (通过)" >> result.txt
          echo "输出:" >> result.txt
          cat output.txt >> result.txt
      
      - name: 执行Python
        if: ${{ github.event.inputs.language == 'python' }}
        run: |
          # 执行
          timeout 2s python3 solution.py < input.txt > output.txt 2> error.txt
          if [ $? -eq 124 ]; then
            echo "::warning::程序超时"
            echo "状态: TLE (超时)" >> result.txt
            exit 0
          elif [ $? -ne 0 ]; then
            echo "::error::运行时错误"
            cat error.txt
            echo "状态: RE (运行时错误)" >> result.txt
            exit 0
          fi
          
          echo "::notice::执行成功"
          echo "状态: AC (通过)" >> result.txt
          echo "输出:" >> result.txt
          cat output.txt >> result.txt
      

      - name: 显示编译错误(如果有)
        if: failure()
        run: cat compile_error.txt

      - name: 上传结果
        uses: actions/upload-artifact@v4
        with:
          name: execution-results
          path: result.txt