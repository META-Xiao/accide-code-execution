name: ACC-IDE Code Judge

on:
  workflow_dispatch:
    inputs:
      # ä»Appæ¥æ”¶è¦è¯„æµ‹çš„ä»£ç 
      source_code:
        description: 'The source code to be judged'
        required: true
      # ä»Appæ¥æ”¶æ ‡å‡†è¾“å…¥
      std_input:
        description: 'Standard input for the code'
        required: false
        default: ''
      # ä»Appæ¥æ”¶é¢„æœŸè¾“å‡º
      expected_output:
        description: 'Expected output for comparison'
        required: false
        default: ''
      # Appä¼ æ¥çš„è¯­è¨€ç±»å‹ï¼Œç”¨äºé€‰æ‹©ç¼–è¯‘å™¨
      language:
        description: 'The programming language (cpp, python, java)'
        required: true
        default: 'cpp'

jobs:
  build-and-run:
    runs-on: ubuntu-latest
    timeout-minutes: 1 

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # æµ‹è¯•Pythonæ­¥éª¤æ˜¯å¦ä¼šæ‰§è¡Œ
      - name: Debug Python Step Test
        run: |
          echo "ğŸ” DEBUG: Language parameter check"
          echo "Language input: '${{ github.event.inputs.language }}'"
          echo "Is language python? $([[ '${{ github.event.inputs.language }}' == 'python' ]] && echo 'YES' || echo 'NO')"
          echo "Default language: cpp"
          if [[ "${{ github.event.inputs.language }}" == "python" ]]; then
            echo "ğŸ PYTHON DETECTED - Python steps should execute"
          else
            echo "âŒ NOT PYTHON - Python steps will be skipped"
            echo "Current language: '${{ github.event.inputs.language }}'"
          fi

      # æ ¹æ®è¯­è¨€ï¼Œå°†æ¥æ”¶åˆ°çš„ä»£ç å’Œè¾“å…¥å†™å…¥æ–‡ä»¶
      - name: Prepare execution files
        run: |
          # ç¦ç”¨é”™è¯¯å¯¼è‡´çš„è„šæœ¬ç»ˆæ­¢
          set +e
          
          # åˆ›å»ºä¸€ä¸ªç»“æœç›®å½•
          mkdir -p results || true

          # è®¾ç½® UTF-8 ç¯å¢ƒå˜é‡
          export LC_ALL=C.UTF-8 || true
          export LANG=C.UTF-8 || true
          
          # å°†è¾“å…¥å†™å…¥æ–‡ä»¶ï¼Œä½¿ç”¨ echo -e ç¡®ä¿è½¬ä¹‰åºåˆ—è¢«æ­£ç¡®å¤„ç†
          echo -e "${{ github.event.inputs.std_input }}" > input.txt || true
          echo -e "${{ github.event.inputs.expected_output }}" > expected.txt || true
          
          # æ£€æŸ¥é¢„æœŸè¾“å‡ºæ˜¯å¦ä¸ºç©ºï¼Œè®¾ç½®ä¸€ä¸ªæ ‡å¿—
          if [ ! -s expected.txt ] || [ "$(cat expected.txt | tr -d '[:space:]')" = "" ]; then
            echo "EXPECTED_EMPTY=true" >> $GITHUB_ENV || true
            echo "é¢„æœŸè¾“å‡ºä¸ºç©ºï¼Œè®¾ç½® EXPECTED_EMPTY=true" || true
          else
            echo "EXPECTED_EMPTY=false" >> $GITHUB_ENV || true
            echo "é¢„æœŸè¾“å‡ºä¸ä¸ºç©ºï¼Œè®¾ç½® EXPECTED_EMPTY=false" || true
          fi
          
          # æ˜¾ç¤ºé¢„æœŸè¾“å‡ºå†…å®¹
          echo "=== Expected Output Content ===" || true
          cat expected.txt || true
          echo "===============================" || true
          
          # æ ¹æ®è¯­è¨€ç¡®å®šæºæ–‡ä»¶å
          if [ "${{ github.event.inputs.language }}" = "java" ]; then
            SOURCE_FILE="Main.java"
          else
            SOURCE_FILE="main.${{ github.event.inputs.language }}"
          fi
          
          # ä½¿ç”¨ base64 è§£ç ç¡®ä¿æºä»£ç ä¸­çš„ç©ºæ ¼å’Œç‰¹æ®Šå­—ç¬¦è¢«æ­£ç¡®ä¿ç•™
          # é¦–å…ˆå°†æºä»£ç å†™å…¥ä¸´æ—¶æ–‡ä»¶ï¼Œç„¶åæ£€æŸ¥å¹¶ç¡®ä¿æ–‡ä»¶æ ¼å¼æ­£ç¡®
          echo "${{ github.event.inputs.source_code }}" > source_code_temp.txt || true
          
          # æ˜¾ç¤ºå¤„ç†å‰çš„æºä»£ç 
          echo "=== Source Code (Before Processing) ===" || true
          cat source_code_temp.txt || true
          echo "=====================================" || true
          
          # ä¿®å¤å¯èƒ½çš„ç©ºæ ¼é—®é¢˜ï¼Œå°†è¿ç»­çš„ << åé¢çš„ç©ºæ ¼ä¿ç•™
          sed -i 's/<<  *;/<< " ";/g' source_code_temp.txt || true
          sed -i 's/<<  *)/<< " ")/g' source_code_temp.txt || true
          sed -i 's/<<  *,/<< " ",/g' source_code_temp.txt || true
          sed -i 's/<<  *$/<< " "/g' source_code_temp.txt || true
          sed -i 's/<<  *\]/<< " "]/g' source_code_temp.txt || true
          sed -i 's/<<  *}/<< " "}/g' source_code_temp.txt || true
          sed -i 's/<<  *>/<< " ">/g' source_code_temp.txt || true
          
          # å¤„ç† >> è¿ç®—ç¬¦å‘¨å›´çš„ç©ºæ ¼
          sed -i 's/>>  *;/>> " ";/g' source_code_temp.txt || true
          sed -i 's/>>  *)/>> " ")/g' source_code_temp.txt || true
          sed -i 's/>>  *,/>> " ",/g' source_code_temp.txt || true
          sed -i 's/>>  *$/>> " "/g' source_code_temp.txt || true
          sed -i 's/>>  *\]/>> " "]/g' source_code_temp.txt || true
          sed -i 's/>>  *}/>> " "}/g' source_code_temp.txt || true
          sed -i 's/>>  *>/>> " ">/g' source_code_temp.txt || true
          
          # ä¿®å¤Pythonè¯­æ³•é”™è¯¯ï¼š__main__ éœ€è¦å¼•å·
          sed -i 's/__main__:/"__main__":/g' source_code_temp.txt || true
          
          # æ˜¾ç¤ºå¤„ç†åçš„æºä»£ç 
          echo "=== Source Code (After Processing) ===" || true
          cat source_code_temp.txt || true
          echo "====================================" || true
          
          # å°†å¤„ç†åçš„æºä»£ç å†™å…¥æœ€ç»ˆæ–‡ä»¶
          cat source_code_temp.txt > $SOURCE_FILE || true
          
          # ç¡®ä¿æºä»£ç æ–‡ä»¶æ˜¯ UTF-8 ç¼–ç 
          echo "=== Converting to UTF-8 ===" || true
          iconv -f ISO-8859-1 -t UTF-8 $SOURCE_FILE -o $SOURCE_FILE.utf8 || true
          mv $SOURCE_FILE.utf8 $SOURCE_FILE || true
          echo "=========================" || true
          
          echo "SOURCE_FILE=$SOURCE_FILE" >> $GITHUB_ENV || true
          
          # æ˜¾ç¤ºæºä»£ç æ–‡ä»¶å†…å®¹ä»¥è¿›è¡Œè°ƒè¯•
          echo "=== Final Source Code ===" || true
          cat $SOURCE_FILE || true
          echo "========================" || true
          
          # æ£€æŸ¥æ–‡ä»¶ç¼–ç 
          echo "=== File Encoding ===" || true
          file -i $SOURCE_FILE || true
          echo "====================" || true
        
      - name: Compile C++ Code
        if: github.event.inputs.language == 'cpp'
        id: compile_cpp
        run: |
          set +e
          g++ --version || true
          
          # åˆ›å»ºç¼–è¯‘æ—¥å¿—ç›®å½•
          mkdir -p ./results || true
          
          # å°è¯•ç¼–è¯‘ä»£ç 
          g++ main.cpp -o main_exec -O2 -std=c++17 -Wall -Wextra -fdiagnostics-color=always > ./results/compile.log 2>&1
          COMPILE_RESULT=$?
          
          # è¾“å‡ºç¼–è¯‘æ—¥å¿—
          echo "=== Compilation Log ===" || true
          cat ./results/compile.log || true
          echo "=======================" || true
          
          if [ $COMPILE_RESULT -ne 0 ]; then
            echo "Compilation failed with exit code: $COMPILE_RESULT" || true
            echo '{"status": "CE", "message": "Compilation Error", "execution_time": 0}' > ./results/result.json || true
            echo "JUDGE_STATUS=CE" >> $GITHUB_ENV || true
          else
            echo "Compilation successful" || true
          fi

      - name: Run and Judge C++ Code
        if: success() && env.JUDGE_STATUS != 'CE' && github.event.inputs.language == 'cpp'
        run: |
          set +e
          
          # æ£€æŸ¥é¢„æœŸè¾“å‡ºæ˜¯å¦ä¸ºç©º
          if [ ! -s expected.txt ] || [ "$(cat expected.txt | tr -d '[:space:]')" = "" ]; then
            EXPECTED_EMPTY=true
          else
            EXPECTED_EMPTY=false
          fi
          
          # è®¡æ—¶è„šæœ¬
          cat > time_wrapper.sh << 'EOF'
          #!/bin/bash
          start_time=$(date +%s%N)
          "$@"
          exit_code=$?
          end_time=$(date +%s%N)
          execution_time=$((($end_time - $start_time) / 1000000))
          echo $execution_time > execution_time.txt
          exit $exit_code
          EOF
          
          chmod +x time_wrapper.sh
          
          # è¿è¡Œæ–‡ä»¶å¹¶é™åˆ¶æ—¶é—´å’Œå†…å­˜
          # TLE: 2 seconds, MLE: 256 MB
          timeout 2s ./time_wrapper.sh ./main_exec < input.txt > ./results/actual.txt 2> ./results/stderr.log || true
          EXIT_CODE=$?
          
          # è·å–æ‰§è¡Œæ—¶é—´
          EXECUTION_TIME=0
          if [ -f execution_time.txt ]; then
            EXECUTION_TIME=$(cat execution_time.txt)
          fi
          
          if [ $EXIT_CODE -eq 124 ]; then
            STATUS="TLE"
            MESSAGE="Time Limit Exceeded"
          elif [ $EXIT_CODE -ne 0 ]; then
            STATUS="RE"
            MESSAGE="Runtime Error (Exit Code: $EXIT_CODE)"
          else
            # æ£€æŸ¥é¢„æœŸæ˜¯å¦ä¸ºç©ºï¼Œç©ºåˆ™"RS"(Run Successful)
            if [ "$EXPECTED_EMPTY" = "true" ]; then
              STATUS="RS"
              MESSAGE="Run Successful"
            else
              # ä½¿ç”¨ diff å‘½ä»¤æ¯”è¾ƒè¾“å‡ºã€‚
              # -i å¿½ç•¥å¤§å°å†™, -w å¿½ç•¥æ‰€æœ‰ç©ºæ ¼, -B å¿½ç•¥ç©ºè¡Œ
              diff -i -w -B ./results/actual.txt expected.txt > /dev/null
              DIFF_RESULT=$?
              if [ $DIFF_RESULT -ne 0 ]; then
                STATUS="WA"
                MESSAGE="Wrong Answer"
                
                echo "=== Expected Output ===" > ./results/diff.txt
                cat expected.txt >> ./results/diff.txt
                echo -e "\n=== Actual Output ===" >> ./results/diff.txt
                cat ./results/actual.txt >> ./results/diff.txt
              else
                STATUS="AC"
                MESSAGE="Accepted"
              fi
            fi
          fi
          
          echo "{\"status\": \"$STATUS\", \"message\": \"$MESSAGE\", \"execution_time\": $EXECUTION_TIME}" > ./results/result.json

          # è¾“å‡ºè°ƒè¯•ä¿¡æ¯
          echo "=== DEBUG INFO (C++) ===" || true
          echo "Input:" || true
          cat input.txt || true
          echo -e "\nExpected Output:" || true
          cat expected.txt || true
          echo -e "\nActual Output:" || true
          cat ./results/actual.txt || true
          echo -e "\nStatus: $STATUS (EXPECTED_EMPTY=$EXPECTED_EMPTY)" || true
          echo "===========================" || true

      - name: Run Python Code
        if: always() && github.event.inputs.language == 'python'
        run: |
          echo "=== PYTHON STEP STARTED ==="
          echo "Language: ${{ github.event.inputs.language }}"
          echo "Working directory: $(pwd)"
          echo "Files in directory:"
          ls -la
          
          # åˆ›å»ºç»“æœç›®å½•
          mkdir -p ./results
          
          # æ£€æŸ¥main.pyæ–‡ä»¶
          echo "=== main.py content ==="
          cat main.py
          echo "======================="

          if [ ! -s expected.txt ] || [ "$(cat expected.txt | tr -d '[:space:]')" = "" ]; then
            EXPECTED_EMPTY=true
          else
            EXPECTED_EMPTY=false
          fi
          
          cat > time_wrapper.sh << 'EOF'
          #!/bin/bash
          start_time=$(date +%s%N)
          "$@"
          exit_code=$?
          end_time=$(date +%s%N)
          execution_time=$((($end_time - $start_time) / 1000000))
          echo $execution_time > execution_time.txt
          exit $exit_code
          EOF
          
          chmod +x time_wrapper.sh
          
          timeout 2s ./time_wrapper.sh python3 main.py < input.txt > ./results/actual.txt 2> ./results/stderr.log || true
          EXIT_CODE=$?
          
          EXECUTION_TIME=0
          if [ -f execution_time.txt ]; then
            EXECUTION_TIME=$(cat execution_time.txt)
          fi
          
          if [ $EXIT_CODE -eq 124 ]; then
            STATUS="TLE"
            MESSAGE="Time Limit Exceeded"
          elif [ $EXIT_CODE -ne 0 ]; then
            STATUS="RE"
            MESSAGE="Runtime Error (Exit Code: $EXIT_CODE)"
          else
            if [ "$EXPECTED_EMPTY" = "true" ]; then
              STATUS="RS"
              MESSAGE="Run Successful"
            else
              diff -i -w -B ./results/actual.txt expected.txt > /dev/null
              DIFF_RESULT=$?
              if [ $DIFF_RESULT -ne 0 ]; then
                STATUS="WA"
                MESSAGE="Wrong Answer"
                
                echo "=== Expected Output ===" > ./results/diff.txt
                cat expected.txt >> ./results/diff.txt
                echo -e "\n=== Actual Output ===" >> ./results/diff.txt
                cat ./results/actual.txt >> ./results/diff.txt
              else
                STATUS="AC"
                MESSAGE="Accepted"
              fi
            fi
          fi
          
          echo "{\"status\": \"$STATUS\", \"message\": \"$MESSAGE\", \"execution_time\": $EXECUTION_TIME}" > ./results/result.json

          echo "=== DEBUG INFO (Python) ===" || true
          echo "Input:" || true
          cat input.txt || true
          echo -e "\nExpected Output:" || true
          cat expected.txt || true
          echo -e "\nActual Output:" || true
          cat ./results/actual.txt || true
          echo -e "\nStatus: $STATUS (EXPECTED_EMPTY=$EXPECTED_EMPTY)" || true
          echo "===========================" || true


      - name: Compile Java Code
        if: github.event.inputs.language == 'java'
        id: compile_java
        run: |
          set +e
          
          javac Main.java -d . &> ./results/compile.log || true
          COMPILE_RESULT=$?
          
          echo "=== Compilation Log ===" || true
          cat ./results/compile.log || true
          echo "=======================" || true
          
          if [ $COMPILE_RESULT -ne 0 ]; then
            echo "Compilation failed with exit code: $COMPILE_RESULT" || true
            echo '{"status": "CE", "message": "Compilation Error", "execution_time": 0}' > ./results/result.json || true
            echo "JUDGE_STATUS=CE" >> $GITHUB_ENV || true
          else
            echo "Compilation successful" || true
          fi

      - name: Run Java Code
        if: success() && env.JUDGE_STATUS != 'CE' && github.event.inputs.language == 'java'
        run: |
          set +e
          
          if [ ! -s expected.txt ] || [ "$(cat expected.txt | tr -d '[:space:]')" = "" ]; then
            EXPECTED_EMPTY=true
          else
            EXPECTED_EMPTY=false
          fi
          
          cat > time_wrapper.sh << 'EOF'
          #!/bin/bash
          start_time=$(date +%s%N)
          "$@"
          exit_code=$?
          end_time=$(date +%s%N)
          execution_time=$((($end_time - $start_time) / 1000000))
          echo $execution_time > execution_time.txt
          exit $exit_code
          EOF
          
          chmod +x time_wrapper.sh
          
          timeout 2s ./time_wrapper.sh java Main < input.txt > ./results/actual.txt 2> ./results/stderr.log || true
          EXIT_CODE=$?
          
          EXECUTION_TIME=0
          if [ -f execution_time.txt ]; then
            EXECUTION_TIME=$(cat execution_time.txt)
          fi
          
          if [ $EXIT_CODE -eq 124 ]; then
            STATUS="TLE"
            MESSAGE="Time Limit Exceeded"
          elif [ $EXIT_CODE -ne 0 ]; then
            STATUS="RE"
            MESSAGE="Runtime Error (Exit Code: $EXIT_CODE)"
          else
            if [ "$EXPECTED_EMPTY" = "true" ]; then
              STATUS="RS" 
              MESSAGE="Run Successful"
            else
              diff -i -w -B ./results/actual.txt expected.txt > /dev/null
              DIFF_RESULT=$?
              if [ $DIFF_RESULT -ne 0 ]; then
                STATUS="WA"
                MESSAGE="Wrong Answer"
                
                echo "=== Expected Output ===" > ./results/diff.txt
                cat expected.txt >> ./results/diff.txt
                echo -e "\n=== Actual Output ===" >> ./results/diff.txt
                cat ./results/actual.txt >> ./results/diff.txt
              else
                STATUS="AC"
                MESSAGE="Accepted"
              fi
            fi
          fi
          
          echo "{\"status\": \"$STATUS\", \"message\": \"$MESSAGE\", \"execution_time\": $EXECUTION_TIME}" > ./results/result.json

          echo "=== DEBUG INFO (Java) ===" || true
          echo "Input:" || true
          cat input.txt || true
          echo -e "\nExpected Output:" || true
          cat expected.txt || true
          echo -e "\nActual Output:" || true
          cat ./results/actual.txt || true
          echo -e "\nStatus: $STATUS (EXPECTED_EMPTY=$EXPECTED_EMPTY)" || true
          echo "===========================" || true

      # ä¸Šä¼ ç»“æœæ–‡ä»¶
      - name: Upload judgment result
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: judge-result
          path: ./results/
          if-no-files-found: warn 
